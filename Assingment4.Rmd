---
title: "206 Assignment 4"
author: "Sidney Gerst"
date: "November 13, 2018"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load Packages and read in files

```{r, echo=FALSE, message=FALSE}
library(tidyverse)
library(pwr)
library(knitr)
library(kableExtra)
library(plotly)
library(ggrepel)
library(effsize)
library(vcdExtra)
library(dplyr)

lobster_pressure <- read_csv("lobster_traps.csv")

lobster_size <- read_csv("lobster_size_abundance.csv")



```

Clean up Data before converting to tidy

```{r, echo=FALSE, message=FALSE}
size_clean <- lobster_size %>%
  select(YEAR, SITE, SIZE, COUNT) %>%
  filter(COUNT != "0")

size_clean

pressure_clean <- lobster_pressure %>%
  select(YEAR, SITE, TRAPS) 
  
pressure_clean



```


Part 1: Lobster abundance and fishing pressure
- Exploratory data analysis
    - Scatter plots with 5 locations with counts and fishing pressure (traps) for 2012-2017 (separately)
    - Column graphs with total count/traps by site
    - Finalized line graphs for abundance and pressure
    
    
```{r, echo=FALSE, message=FALSE}

## Make scatter plot for annual abundance by site (2012-2017)
abundance <- size_clean %>% 
  select(YEAR, SITE, COUNT) %>% 
  group_by(SITE, YEAR) %>% 
  summarize (
      total_count = round(sum(COUNT), digits = 1)
    ) %>% 
  ggplot(aes(x=YEAR, y = total_count))+
  geom_point() +
  facet_wrap(~SITE, scale = "free") +
  xlab("Year") +
  ylab("Total Count")+
  theme_classic()+
  ggtitle("Total Lobster Abundance (2012-2017) - TH, EM, SG")
  

abundance


## Make column graph of total abundance by site (2012-2017)
abundance_col <- ggplot(size_clean, aes(x = YEAR, y = COUNT))+
  geom_col()+
  facet_wrap(~SITE, scale = "free")+
  theme_classic()+
  ggtitle("Total Lobster Abundance (2012-2017) - TH, EM, SG")

abundance_col


## Make line graph of total abundance within each site (2012-2017)
abundance_line <- as.data.frame(size_clean) %>% 
  expand.dft(freq="COUNT") %>% 
  count(YEAR, SITE) %>% 
  ggplot(aes(x=YEAR, y = n))+
  geom_line(aes(color=SITE)) +
  xlab("Year") +
  ylab("Total Count")+
  ggtitle("Lobster Abundance at LTER Sites in the Santa Barbara Channel - TH, EM, SG")+
  theme_classic()
  

abundance_line


```


```{r, echo=FALSE, message=FALSE}

# Make a scatter plot for annual lobster pressure for each site (2012-2017)
pressure <- pressure_clean %>% 
  select(YEAR, SITE, TRAPS) %>%
  filter(SITE == "AQUE"| SITE == "NAPL" | SITE == "MOHK"| SITE == "IVEE"| SITE == "CARP") %>% 
  group_by(SITE, YEAR) %>% 
  summarize (
      total_traps = round(sum(TRAPS), digits = 1)
    ) %>% 
  ggplot(aes(x=YEAR, y = total_traps))+
  geom_point() +
  facet_wrap(~SITE, scale = "free") +
  xlab("Year") +
  ylab("Total Pressure")+
  ggtitle("Lobster Abundance (2012-2017) - TH, EM, SG")+
  theme_classic()

pressure


# Make final pressure data frame (with just 5 sites)
pressure_final <- pressure_clean %>% 
  select(YEAR, SITE, TRAPS) %>%
  filter(SITE == "AQUE"| SITE == "NAPL" | SITE == "MOHK"| SITE == "IVEE"| SITE == "CARP")
 

# Make a column graph for total pressure for each site (2012-2017)
pressure_col <- ggplot(pressure_final, aes(x = YEAR, y = TRAPS))+
  geom_col()+
  facet_wrap(~SITE, scale = "free")+
  theme_classic()+
  ggtitle("Total Lobster Fishing Pressure (2012-2017) - TH, EM, SG")

pressure_col


# Make line graph of total pressure within each site (2012-2017)
pressure_line <- as.data.frame(pressure_final) %>% 
  expand.dft(freq="TRAPS") %>% 
  count(YEAR, SITE) %>% 
  ggplot(aes(x=YEAR, y = n))+
  geom_line(aes(color=SITE)) +
  xlab("Year") +
  ylab("Total Pressure")+
  ggtitle("Lobster Fishing Pressure at LTER Sites in Santa Barbara Channel - TH, EM, SG")+
  theme_classic()

pressure_line



```

Discuss trends in lobster abundance (counts) and fishing pressure (buoys):
- In each of the five sites, the total lobster abundance is greater in 2017 than it was in 2012. However, counts vary greatly over the 5 years. At the AQUE site, counts were much greater over the course of all 5 years than at the other sites. CARP had a dramatic increase in 2017, whereas prior to that the counts were very low. AQUE, CARP, and IVEE all ended 2017 with counts higher than the previous year, while the other two sites, MOHK and NAPL, experienced decline in their final year. An analysis of lobster pressure may partially explain trends in lobster abundance. Within the AQUE, MOHK, and CARP sites there was a decline in lobster fishing pressure between 2016 and 2017. This could have caused the significant increase in lobster abundance seen at the CARP site within the same time frame. In general, lobster fishing pressure decreased between 2012 and 2017 at CARP, MOH, and AQUE. NAPL and IVEE are Marine Protected Areas (MPA's) and so have zero fishing pressure. 



Part 2. Compare mean lobster size by site in 2017

- Convert to tidy format
- Exploratory data analysis 
```{r}

# Convert abundance data frame into tidy format

abundance_tidy <- as.data.frame(size_clean) %>% 
  expand.dft(freq="COUNT")

abundance_tidy

#Create data frame for our 5 locations in 2017, selecting size.
sizes_2017 <- abundance_tidy %>% 
  filter(YEAR == 2017,
         SITE == "AQUE"|SITE == "NAPL"|SITE == "MOHK"|SITE == "IVEE"|SITE == "CARP",
         SIZE != "-99999")
View(sizes_2017)

# Basic data exploration

size_hist <- ggplot(sizes_2017, aes(x = SIZE)) +
  geom_histogram(bins = 10) +
  facet_wrap(~ SITE, scale = "free")

size_hist
  
size_qq <- ggplot(sizes_2017, aes(sample = SIZE)) +
  geom_qq(bins = 10) +
  facet_wrap(~ SITE, scale = "free")

size_qq

#We see the data is approximately normally distributed at every site in 2017.

box_


```



Part 3. Changes in lobster size at MPA and non-MPA sites (comparing only 2012 and 2017 sizes)
  - Exploratory data analysis
      - Summary data table with size means within MPA sites during 2012 and 2017
      - Summary data table with size within non-MPA sites during 2012 and 2017
  - Hypothesis test for size change in MPA sites during 2012 and 2017
      - Null Hypothesis -- there is no significant difference in carapace length (2012 and 2017)
      - Alternative Hypothesis -- there IS a significant difference in carapace length (2012 and             2017)
  - Hypothesis test for size change in non-MPA sites during 2012 and 2017
      - Null Hypothesis -- there is no significant difference in carapace length between 2012 and            2017
      - Alternative Hypothesis -- there IS a significant difference in carapace length (2012-2017)
  - Hypothesis test to compare carapace length between MPA sites and non-MPA sites during 2012 (and      separately 2017)
      - Null Hypothesis -- there is no significant difference in carapace length of lobsters in MPA          sites and non-MPA sites
      - Alternative Hypothesis -- there IS no significant difference in carapace length of lobsters          in MPA sites and non-MPA sites
      
```{r}

### EXPLORATORY DATA ANALYSIS

## Set up data frame that assigns MPA or non-MPA designation

MPA_sites <- abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  mutate(
    STATUS = case_when(
      SITE == "IVEE" ~ "MPA", 
      SITE == "NAPL" ~ "MPA",
      SITE == "AQUE" ~ "Non-MPA",
      SITE == "MOHK" ~ "Non-MPA",
      SITE == "CARP" ~ "Non-MPA")) %>% 
  select(YEAR, SITE, SIZE, STATUS)


## Create summary data table for MPA sites with mean, median, max, SD, sample size for SIZE at each site for 2012 and 2017  (IVEE, NAPL)

MPA_size_table <- MPA_sites %>% 
  filter(STATUS == "MPA") %>% 
  group_by(YEAR) %>% 
  summarize(
    mean_size = round(mean(SIZE), 2), 
    median_size = round(median(SIZE), 2),
    max_size = round(max(SIZE), 2),
    sd_size = round(sd(SIZE), 2),
    length(SIZE)
  )

MPA_size_table


## Create summary data table for NON-MPA sites with mean, median, max, SD, sample size for SIZE at each site for 2012 and 2017 (AQUE, MOHK, CARP)
Non_MPA_size_table <- MPA_sites %>% 
  filter(STATUS == "Non-MPA") %>% 
  group_by(YEAR) %>% 
  summarize(
    mean_size = round(mean(SIZE), 2), 
    median_size = round(median(SIZE), 2),
    max_size = round(max(SIZE), 2),
    sd_size = round(sd(SIZE), 2),
    length(SIZE)
  )

Non_MPA_size_table
      

 
```

